name: Security Scanning Pipeline

on:
  schedule:
    # Run comprehensive security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - vulnerability-only
          - dependency-only
          - container-only
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.cs'
      - '**/*.js'
      - '**/*.ts'
      - '**/*.json'
      - '**/Dockerfile*'
      - '**/package*.json'
      - '**/*.csproj'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ==========================================
  # DEPENDENCY VULNERABILITY SCANNING
  # ==========================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'comprehensive' || inputs.scan_type == 'dependency-only' || github.event_name == 'schedule' || github.event_name == 'push' }}
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: ðŸ—ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ðŸ” .NET vulnerability scan
      run: |
        # Restore packages
        dotnet restore src/OilTrading.sln
        
        # Check for vulnerable packages
        dotnet list src/OilTrading.sln package --vulnerable --include-transitive > dotnet-vulnerabilities.txt
        
        # Check if vulnerabilities were found
        if grep -q "has the following vulnerable packages" dotnet-vulnerabilities.txt; then
          echo "âŒ Vulnerable .NET packages found:"
          cat dotnet-vulnerabilities.txt
          echo "vulnerable-dotnet-packages=true" >> $GITHUB_ENV
        else
          echo "âœ… No vulnerable .NET packages found"
          echo "vulnerable-dotnet-packages=false" >> $GITHUB_ENV
        fi

    - name: ðŸ” npm vulnerability scan
      working-directory: frontend
      run: |
        # Install packages
        npm ci --only=production
        
        # Run security audit
        npm audit --audit-level=moderate --json > npm-audit-results.json || true
        
        # Check results
        VULNERABILITIES=$(jq '.metadata.vulnerabilities.total' npm-audit-results.json 2>/dev/null || echo "0")
        
        if [ "$VULNERABILITIES" -gt 0 ]; then
          echo "âŒ Found $VULNERABILITIES npm vulnerabilities"
          npm audit --audit-level=moderate
          echo "vulnerable-npm-packages=true" >> $GITHUB_ENV
        else
          echo "âœ… No npm vulnerabilities found"
          echo "vulnerable-npm-packages=false" >> $GITHUB_ENV
        fi

    - name: ðŸ” Snyk dependency scan
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=medium --json-file-output=snyk-results.json

    - name: ðŸ” OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'oil-trading-system'
        path: '.'
        format: 'ALL'
        out: 'dependency-check-reports'
        args: >
          --enableRetired
          --enableExperimental
          --suppression suppression.xml

    - name: ðŸ“¤ Upload OWASP Dependency Check results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-check-results
        path: dependency-check-reports/

    - name: âŒ Fail on critical vulnerabilities
      run: |
        if [ "${{ env.vulnerable-dotnet-packages }}" = "true" ] || [ "${{ env.vulnerable-npm-packages }}" = "true" ]; then
          echo "âŒ Critical vulnerabilities found in dependencies"
          exit 1
        else
          echo "âœ… No critical vulnerabilities found in dependencies"
        fi

  # ==========================================
  # CODE SECURITY ANALYSIS
  # ==========================================
  code-security-scan:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'comprehensive' || inputs.scan_type == 'vulnerability-only' || github.event_name == 'schedule' || github.event_name == 'push' }}
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”’ Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: csharp, javascript
        queries: security-extended,security-and-quality

    - name: ðŸ—ï¸ Setup .NET for CodeQL
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: ðŸ—ï¸ Build for CodeQL analysis
      run: |
        dotnet restore src/OilTrading.sln
        dotnet build src/OilTrading.sln --configuration Release --no-restore

    - name: ðŸ”’ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:csharp"

    - name: ðŸ” Run Semgrep security analysis
      uses: returntocorp/semgrep-action@v1
      with:
        config: >
          p/security-audit
          p/owasp-top-ten
          p/cwe-top-25
          p/r2c-security-audit
        generateSarif: "1"

    - name: ðŸ“¤ Upload Semgrep results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: semgrep.sarif

    - name: ðŸ” Run Bandit security scan (Python risk engine)
      run: |
        pip install bandit[toml]
        bandit -r src/OilTrading.Api/Scripts/ -f json -o bandit-results.json || true
        
        if [ -f bandit-results.json ]; then
          ISSUES=$(jq '.results | length' bandit-results.json)
          if [ "$ISSUES" -gt 0 ]; then
            echo "âŒ Found $ISSUES security issues in Python code"
            jq '.results' bandit-results.json
          else
            echo "âœ… No security issues found in Python code"
          fi
        fi

    - name: ðŸ” Run ESLint security scan for frontend
      working-directory: frontend
      run: |
        npm ci --only=dev
        npx eslint src/ --ext .js,.jsx,.ts,.tsx --format json -o eslint-security-results.json || true
        
        if [ -f eslint-security-results.json ]; then
          ISSUES=$(jq '[.[] | select(.messages | length > 0)] | length' eslint-security-results.json)
          if [ "$ISSUES" -gt 0 ]; then
            echo "âŒ Found $ISSUES ESLint security issues"
            cat eslint-security-results.json
          else
            echo "âœ… No ESLint security issues found"
          fi
        fi

  # ==========================================
  # CONTAINER SECURITY SCANNING
  # ==========================================
  container-security-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'comprehensive' || inputs.scan_type == 'container-only' || github.event_name == 'schedule' }}
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ³ Build container image for scanning
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.production
        push: false
        tags: oil-trading-system:scan
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ðŸ” Run Trivy container scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'oil-trading-system:scan'
        format: 'sarif'
        output: 'trivy-container-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: ðŸ“¤ Upload Trivy container results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-container-results.sarif'

    - name: ðŸ” Run Grype container vulnerability scan
      run: |
        # Install Grype
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
        
        # Scan container image
        grype oil-trading-system:scan -o json > grype-results.json
        
        # Check results
        CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' grype-results.json)
        HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' grype-results.json)
        
        echo "Critical vulnerabilities: $CRITICAL"
        echo "High vulnerabilities: $HIGH"
        
        if [ "$CRITICAL" -gt 0 ]; then
          echo "âŒ Critical vulnerabilities found in container image"
          jq '.matches[] | select(.vulnerability.severity == "Critical")' grype-results.json
          echo "critical-container-vulns=true" >> $GITHUB_ENV
        else
          echo "âœ… No critical vulnerabilities found in container image"
          echo "critical-container-vulns=false" >> $GITHUB_ENV
        fi

    - name: ðŸ” Run Hadolint Dockerfile scan
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile.production
        format: sarif
        output-file: hadolint-results.sarif

    - name: ðŸ“¤ Upload Hadolint results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: hadolint-results.sarif

    - name: ðŸ” Run Dockle container linter
      run: |
        # Install Dockle
        VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        curl -L -o dockle.deb https://github.com/goodwithtech/dockle/releases/download/${VERSION}/dockle_${VERSION#v}_Linux-64bit.deb
        sudo dpkg -i dockle.deb
        
        # Scan image
        dockle --format json --output dockle-results.json oil-trading-system:scan || true
        
        if [ -f dockle-results.json ]; then
          FATAL=$(jq '[.details[] | select(.level == "FATAL")] | length' dockle-results.json)
          WARN=$(jq '[.details[] | select(.level == "WARN")] | length' dockle-results.json)
          
          echo "Fatal issues: $FATAL"
          echo "Warning issues: $WARN"
          
          if [ "$FATAL" -gt 0 ]; then
            echo "âŒ Fatal container security issues found"
            jq '.details[] | select(.level == "FATAL")' dockle-results.json
          fi
        fi

    - name: âŒ Fail on critical container vulnerabilities
      run: |
        if [ "${{ env.critical-container-vulns }}" = "true" ]; then
          echo "âŒ Critical vulnerabilities found in container image"
          exit 1
        else
          echo "âœ… No critical vulnerabilities found in container image"
        fi

  # ==========================================
  # INFRASTRUCTURE SECURITY SCAN
  # ==========================================
  infrastructure-security-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    if: ${{ inputs.scan_type == 'comprehensive' || github.event_name == 'schedule' }}
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ” Kubernetes manifest security scan
      run: |
        # Install kubesec
        curl -sSfL https://github.com/controlplaneio/kubesec/releases/latest/download/kubesec_linux_amd64.tar.gz | tar -xz -C /tmp
        sudo mv /tmp/kubesec /usr/local/bin/
        
        # Scan Kubernetes manifests
        find k8s/ -name "*.yaml" -exec kubesec scan {} \; > kubesec-results.json || true
        
        # Check for security issues
        if grep -q '"score": 0' kubesec-results.json; then
          echo "âŒ Security issues found in Kubernetes manifests"
          cat kubesec-results.json
        else
          echo "âœ… No critical security issues found in Kubernetes manifests"
        fi

    - name: ðŸ” Helm chart security scan
      run: |
        # Install helm-secrets plugin for secret scanning
        helm plugin install https://github.com/jkroepke/helm-secrets || true
        
        # Lint Helm charts for security issues
        helm lint helm/oil-trading-system/ || echo "Helm lint issues found"
        
        # Template charts and scan for secrets
        helm template oil-trading-system helm/oil-trading-system/ > templated-manifests.yaml
        
        # Check for potential secrets in templates
        if grep -i "password\|secret\|key\|token" templated-manifates.yaml; then
          echo "âš ï¸ Potential secrets found in Helm templates - please review"
        else
          echo "âœ… No obvious secrets found in Helm templates"
        fi

    - name: ðŸ” Run Checkov infrastructure scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: kubernetes,dockerfile
        output_format: sarif
        output_file_path: checkov-results.sarif

    - name: ðŸ“¤ Upload Checkov results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: checkov-results.sarif

  # ==========================================
  # SECURITY SUMMARY REPORT
  # ==========================================
  security-summary:
    name: Security Summary Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security-scan, container-security-scan, infrastructure-security-scan]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate security summary
      run: |
        cat > security-summary.md << 'EOF'
        # Security Scan Summary Report
        
        **Scan Date**: $(date -u)
        **Repository**: ${{ github.repository }}
        **Branch**: ${{ github.ref_name }}
        **Commit**: ${{ github.sha }}
        
        ## Scan Results Overview
        
        | Scan Type | Status | Notes |
        |-----------|--------|-------|
        | Dependency Scan | ${{ needs.dependency-scan.result }} | .NET and npm packages scanned |
        | Code Security | ${{ needs.code-security-scan.result }} | CodeQL, Semgrep, ESLint analysis |
        | Container Security | ${{ needs.container-security-scan.result }} | Trivy, Grype, Dockle scanning |
        | Infrastructure | ${{ needs.infrastructure-security-scan.result }} | K8s manifests, Helm charts |
        
        ## Recommendations
        
        - Review all SARIF reports uploaded to GitHub Security tab
        - Address any critical or high-severity vulnerabilities immediately
        - Keep dependencies updated regularly
        - Follow secure coding practices
        - Regularly review and update security policies
        
        ## Next Steps
        
        1. Check GitHub Security tab for detailed findings
        2. Create issues for any critical vulnerabilities
        3. Update security documentation as needed
        4. Schedule regular security reviews
        
        ---
        *Generated by Oil Trading System Security Pipeline*
        EOF

    - name: ðŸ“¤ Upload security summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary-${{ github.run_number }}
        path: security-summary.md

    - name: ðŸ“¢ Notify security team
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        fields: repo,message,commit,author,workflow
        text: |
          ðŸš¨ Security scan failures detected!
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Please review the security findings immediately.
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK_URL }}