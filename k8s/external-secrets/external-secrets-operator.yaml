# External Secrets Operator Installation and Configuration
# This provides secure secrets management for Oil Trading System

---
# External Secrets Operator Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets-system
  labels:
    name: external-secrets-system
    app: external-secrets-operator

---
# Vault SecretStore for Production
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: secrets
spec:
  provider:
    vault:
      server: "https://vault.production.example.com"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "oil-trading-system"
          serviceAccountRef:
            name: oil-trading-vault-auth

---
# Kubernetes Service Account for Vault Authentication
apiVersion: v1
kind: ServiceAccount
metadata:
  name: oil-trading-vault-auth
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: vault-auth

---
# ClusterSecretStore for Cross-Namespace Access
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-cluster-backend
  labels:
    app: oil-trading-system
spec:
  provider:
    vault:
      server: "https://vault.production.example.com"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "oil-trading-system-cluster"
          serviceAccountRef:
            name: oil-trading-vault-auth
            namespace: oil-trading

---
# External Secret for Database Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oil-trading-database-secrets
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: database-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: oil-trading-database-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        database-password: "{{ .database_password }}"
        database-connection-string: "Host=postgresql;Port=5432;Database=OilTradingDb;Username=postgres;Password={{ .database_password }}"
        database-read-connection-string: "Host=postgresql-read;Port=5432;Database=OilTradingDb;Username=postgres;Password={{ .database_password }}"
  data:
    - secretKey: database_password
      remoteRef:
        key: oil-trading/database
        property: password

---
# External Secret for Redis Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oil-trading-redis-secrets
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: redis-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: oil-trading-redis-secrets
    creationPolicy: Owner
  data:
    - secretKey: redis-password
      remoteRef:
        key: oil-trading/redis
        property: password

---
# External Secret for JWT and API Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oil-trading-auth-secrets
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: auth-secrets
spec:
  refreshInterval: 6h  # Refresh more frequently for auth secrets
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: oil-trading-auth-secrets
    creationPolicy: Owner
  data:
    - secretKey: jwt-secret
      remoteRef:
        key: oil-trading/auth
        property: jwt-secret
    - secretKey: external-api-key
      remoteRef:
        key: oil-trading/external-apis
        property: primary-api-key
    - secretKey: encryption-key
      remoteRef:
        key: oil-trading/encryption
        property: master-key

---
# External Secret for TLS Certificates
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: oil-trading-tls-secrets
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: tls-secrets
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: oil-trading-tls-manual
    creationPolicy: Owner
    template:
      type: kubernetes.io/tls
  data:
    - secretKey: tls.crt
      remoteRef:
        key: oil-trading/tls
        property: certificate
    - secretKey: tls.key
      remoteRef:
        key: oil-trading/tls
        property: private-key

---
# AWS Secrets Manager SecretStore (Alternative)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-backend
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: aws-secrets
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        serviceAccount:
          name: oil-trading-aws-auth

---
# Azure Key Vault SecretStore (Alternative)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault-backend
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: azure-secrets
spec:
  provider:
    azurekv:
      vaultUrl: "https://oil-trading-kv.vault.azure.net"
      authType: ServicePrincipal
      serviceAccountRef:
        name: oil-trading-azure-auth

---
# Google Secret Manager SecretStore (Alternative)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcp-secrets-backend
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: gcp-secrets
spec:
  provider:
    gcpsm:
      projectId: oil-trading-production
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: oil-trading-cluster
          serviceAccountRef:
            name: oil-trading-gcp-auth

---
# Secret for External Secrets Operator Configuration
apiVersion: v1
kind: Secret
metadata:
  name: external-secrets-config
  namespace: external-secrets-system
  labels:
    app: external-secrets-operator
type: Opaque
data:
  # Base64 encoded configuration values
  vault-token: "" # Will be populated by CI/CD or manual setup
  aws-access-key: ""
  azure-client-secret: ""
  gcp-service-account: ""