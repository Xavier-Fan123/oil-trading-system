# ConfigMap Management and Hot Reload Configuration
# Enables dynamic configuration updates without pod restarts

---
# Reloader Deployment for ConfigMap Hot Reload
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reloader
  namespace: oil-trading
  labels:
    app: reloader
    component: config-management
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reloader
  template:
    metadata:
      labels:
        app: reloader
    spec:
      serviceAccountName: reloader
      containers:
      - name: reloader
        image: stakater/reloader:v1.0.46
        imagePullPolicy: IfNotPresent
        env:
        - name: RELOADER_NAMESPACE
          value: "oil-trading"
        - name: RELOADER_LOG_LEVEL
          value: "info"
        - name: RELOADER_ENABLE_PROMETHEUS
          value: "true"
        ports:
        - name: http
          containerPort: 9090
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /metrics
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /metrics
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          limits:
            memory: "128Mi"
            cpu: "100m"
          requests:
            memory: "64Mi"
            cpu: "50m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL

---
# Service Account for Reloader
apiVersion: v1
kind: ServiceAccount
metadata:
  name: reloader
  namespace: oil-trading
  labels:
    app: reloader

---
# ClusterRole for Reloader
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: reloader-role
rules:
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["list", "get", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "daemonsets", "statefulsets"]
  verbs: ["list", "get", "update", "patch"]
- apiGroups: ["extensions"]
  resources: ["deployments", "daemonsets"]
  verbs: ["list", "get", "update", "patch"]

---
# ClusterRoleBinding for Reloader
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: reloader-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: reloader-role
subjects:
- kind: ServiceAccount
  name: reloader
  namespace: oil-trading

---
# ConfigMap Versioning and Management
apiVersion: v1
kind: ConfigMap
metadata:
  name: oil-trading-config-v1
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: configuration
    version: "v1"
  annotations:
    reloader.stakater.com/match: "true"
    config.version: "1.0.0"
    config.checksum: ""  # Will be populated by CI/CD
data:
  # Application Configuration
  appsettings.json: |
    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft.AspNetCore": "Warning",
          "Microsoft.EntityFrameworkCore": "Warning",
          "OilTrading": "Information"
        }
      },
      "AllowedHosts": "*",
      "HealthChecks": {
        "Enabled": true,
        "HealthCheckGracePeriod": "00:00:30"
      },
      "Monitoring": {
        "EnableMetrics": true,
        "EnableTracing": true,
        "SampleRate": 0.1
      },
      "CacheSettings": {
        "DefaultExpiration": "00:30:00",
        "SlidingExpiration": "00:15:00",
        "AbsoluteExpiration": "01:00:00"
      },
      "RiskSettings": {
        "CalculationInterval": "00:05:00",
        "VaRConfidenceLevel": 0.95,
        "StressTestEnabled": true
      },
      "Features": {
        "EnableRealTimeRisk": true,
        "EnableAdvancedAnalytics": true,
        "EnablePriceValidation": true,
        "EnableAuditLogging": true
      }
    }

  # Database Configuration
  database.json: |
    {
      "ConnectionTimeout": 30,
      "CommandTimeout": 120,
      "EnableSensitiveDataLogging": false,
      "EnableRetryOnFailure": true,
      "MaxRetryCount": 3,
      "MaxRetryDelay": "00:00:30",
      "EnableServiceProviderCaching": true,
      "EnableSplitQueries": true
    }

  # Redis Configuration
  redis.json: |
    {
      "Database": 0,
      "ConnectTimeout": 5000,
      "SyncTimeout": 5000,
      "ResponseTimeout": 5000,
      "ConnectRetry": 3,
      "KeepAlive": 180,
      "DefaultDatabase": 0,
      "Ssl": false,
      "SslProtocols": "Tls12"
    }

  # Security Configuration
  security.json: |
    {
      "RequireHttps": true,
      "EnableCors": true,
      "CorsAllowedOrigins": [
        "https://oiltrading.example.com",
        "https://staging.oiltrading.example.com"
      ],
      "EnableRateLimiting": true,
      "RateLimitRequests": 100,
      "RateLimitWindow": "00:01:00",
      "EnableRequestSizeLimit": true,
      "MaxRequestSize": 10485760
    }

---
# Environment-specific ConfigMap for Development
apiVersion: v1
kind: ConfigMap
metadata:
  name: oil-trading-config-development
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: configuration
    environment: development
data:
  environment: "Development"
  debug.enabled: "true"
  logging.level: "Debug"
  database.enableSensitiveLogging: "true"
  features.enableDeveloperMode: "true"

---
# Environment-specific ConfigMap for Staging
apiVersion: v1
kind: ConfigMap
metadata:
  name: oil-trading-config-staging
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: configuration
    environment: staging
data:
  environment: "Staging"
  debug.enabled: "false"
  logging.level: "Information"
  database.enableSensitiveLogging: "false"
  features.enableStagingMode: "true"
  features.enableTestData: "true"

---
# Environment-specific ConfigMap for Production
apiVersion: v1
kind: ConfigMap
metadata:
  name: oil-trading-config-production
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: configuration
    environment: production
data:
  environment: "Production"
  debug.enabled: "false"
  logging.level: "Warning"
  database.enableSensitiveLogging: "false"
  features.enableProductionMode: "true"
  features.enableOptimizations: "true"

---
# ConfigMap for Nginx Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config-v1
  namespace: oil-trading
  labels:
    app: oil-trading-system
    component: nginx-config
    version: "v1"
  annotations:
    reloader.stakater.com/match: "true"
data:
  nginx.conf: |
    # Optimized Nginx Configuration - Managed by ConfigMap
    user nginxuser;
    worker_processes auto;
    pid /var/run/nginx.pid;
    error_log /var/log/nginx/error.log warn;

    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
        access_log /var/log/nginx/access.log main;

        # Performance
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Compression
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_comp_level 6;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

        # Rate limiting
        limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
        limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

        # Upstream
        upstream api_backend {
            server oil-trading-api:8080;
            keepalive 32;
        }

        server {
            listen 8080;
            server_name _;
            root /usr/share/nginx/html;
            index index.html;

            # Rate limiting
            limit_req zone=general burst=20 nodelay;

            # Health check
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }

            # API proxy
            location /api/ {
                limit_req zone=api burst=50 nodelay;
                proxy_pass http://api_backend/;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_connect_timeout 5s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }

            # Static files
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
                gzip_static on;
            }

            # HTML files
            location ~* \.html$ {
                expires 1h;
                add_header Cache-Control "public, must-revalidate";
            }

            # SPA routing
            location / {
                try_files $uri $uri/ /index.html;
            }

            # Status for monitoring
            location /nginx_status {
                stub_status on;
                access_log off;
                allow 127.0.0.1;
                allow 10.0.0.0/8;
                deny all;
            }
        }
    }

---
# ConfigMap Hot Reload Service
apiVersion: v1
kind: Service
metadata:
  name: reloader
  namespace: oil-trading
  labels:
    app: reloader
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 9090
    targetPort: 9090
  selector:
    app: reloader